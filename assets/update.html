{% extends "admin/challenges/update.html" %}

{% block connection_info %}
<div class="form-group d-none">
	<label>
		Connection Info<br>
		<small class="form-text text-muted">
			Auto-generated from container connection settings
		</small>
	</label>
	<input type="text" class="form-control chal-connection-info" name="connection_info"
		value="{{ challenge.container_connection_info | default('', true) }}" readonly>
</div>
{% endblock %}

{% block value %}
<div class="form-group">
	<label for="scoring_type">Scoring Type<br>
		<small class="form-text text-muted">
			Choose between static points or dynamic decay scoring
		</small>
	</label>
	<select class="form-control" id="scoring_type" name="scoring_type">
		<option value="standard" {% if challenge.type=='standard' or not challenge.container_decay %}selected{% endif
			%}>Standard (Fixed Points)</option>
		<option value="dynamic" {% if challenge.container_decay %}selected{% endif %}>Dynamic (Decay-based)</option>
	</select>
</div>

<!-- Standard Scoring -->
<div id="standard-scoring" class="scoring-section" {% if challenge.container_decay %}style="display: none;" {% endif %}>
	<div class="form-group">
		<label for="value">Points<br>
			<small class="form-text text-muted">
				Fixed number of points for this challenge
			</small>
		</label>
		<input type="number" class="form-control" name="value" id="standard_value"
			value="{{ challenge.value if not challenge.container_decay else '' }}">
	</div>
</div>

<!-- Dynamic Scoring -->
<div id="dynamic-scoring" class="scoring-section" {% if not challenge.container_decay %}style="display: none;" {% endif
	%}>
	<div class="form-group">
		<label for="value">Current Value<br>
			<small class="form-text text-muted">
				This is how many points the challenge is worth right now.
			</small>
		</label>
		<input type="number" class="form-control chal-value" name="current_value" value="{{ challenge.value }}"
			disabled>
	</div>

	<div class="form-group">
		<label for="initial">Initial Value<br>
			<small class="form-text text-muted">
				This is how many points the challenge was worth initially.
			</small>
		</label>
		<input type="number" class="form-control chal-initial" name="initial" id="dynamic_initial"
			value="{{ challenge.container_initial }}">
	</div>

	<div class="form-group">
		<label for="decay_function">Decay Function<br>
			<small class="form-text text-muted">
				How the points decrease as more teams solve
			</small>
		</label>
		<select class="form-control" name="decay_function" id="decay_function">
			<option value="linear" {% if challenge.decay_function=='linear' or not challenge.decay_function %}selected{%
				endif %}>Linear</option>
			<option value="logarithmic" {% if challenge.decay_function=='logarithmic' %}selected{% endif %}>Logarithmic
			</option>
		</select>
	</div>

	<div class="form-group">
		<label for="decay">Decay Limit<br>
			<small class="form-text text-muted">
				The number of solves before the challenge reaches its minimum value
			</small>
		</label>
		<input type="number" class="form-control chal-decay" name="decay" id="dynamic_decay"
			value="{{ challenge.container_decay }}">
	</div>

	<div class="form-group">
		<label for="minimum">Minimum Value<br>
			<small class="form-text text-muted">
				This is the lowest that the challenge can be worth
			</small>
		</label>
		<input type="number" class="form-control chal-minimum" name="minimum" id="dynamic_minimum"
			value="{{ challenge.container_minimum }}">
	</div>
</div>

<div class="form-group">
	<script>
		var container_image_selected = "{{ challenge.image }}";
		var container_connection_type_selected = "{{ challenge.container_connection_type }}";
	</script>
	<label>
		Image<br>
		<small class="form-text text-muted">
			Name of the Docker image to spin up
		</small>
	</label>
	<select type="text" class="form-control" name="image" placeholder="Enter image" id="container-image"
		title="Name of the Docker image to spin up" required disabled>
		<option value="" id="container-image-default" disabled selected>Loading...</option>
	</select>
</div>

<div class="form-group">
	<label>
		Connect type<br>
		<small class="form-text text-muted">
			Connect via HTTP, TCP, or SSH
		</small>
	</label>
	<select type="text" class="form-control" name="connection_type" placeholder="Connect via" id="connect-type"
		title="Connect via web or tcp" required>
		<option value="" selected disabled>Choose a value...</option>
		<option value="http">Web (HTTP)</option>
		<option value="tcp">TCP</option>
		<option value="ssh">SSH</option>
	</select>
</div>

<div class="form-group">
	<label>
		Internal Port(s)<br>
		<small class="form-text text-muted">
			Internal container ports to expose (comma separated, e.g. "80,22")
		</small>
	</label>
	<input type="text" class="form-control" name="internal_ports"
		value="{{ challenge.internal_ports or challenge.internal_port }}"
		oninput="document.getElementById('internal_port_hidden').value = this.value.split(',')[0].trim() || '22'"
		required>
	<input type="hidden" name="internal_port" id="internal_port_hidden" value="{{ challenge.internal_port }}">
</div>

<div class="form-group">
	<label>
		Docker Command (Optional)<br>
		<small class="form-text text-muted">
			Custom command to run in container (leave empty to use image default)
		</small>
	</label>
	<input type="text" class="form-control" name="command" value="{{ challenge.command }}">
</div>

<!-- Flag Pattern Configuration -->
<div class="form-group">
	<label for="flag_pattern">Flag Pattern<br>
		<small class="form-text text-muted">
			<strong>Easy flag configuration! Just enter your flag pattern:</strong>
			<ul>
				<li><strong>Static flag:</strong> <code>CTF{this_is_the_flag}</code> → Same flag for everyone</li>
				<li><strong>Random flag:</strong> <code>CTF{this_is_the_flag_&lt;ran_8&gt;}</code> → Unique flag per
					team/user
					<ul>
						<li><code>&lt;ran_8&gt;</code> will be replaced with 8 random characters</li>
						<li><code>&lt;ran_16&gt;</code> for 16 characters, etc.</li>
					</ul>
				</li>
			</ul>
			<em>Note: You don't need to manually add flags in the flag popup!</em>
		</small>
	</label>
	<input type="text" class="form-control" id="flag_pattern" placeholder="CTF{example_flag}" />
	<small id="flag_pattern_preview" class="form-text text-info"></small>
</div>

<script>
	// Build flag pattern from existing values
	document.addEventListener('DOMContentLoaded', function () {
		const mode = "{{ challenge.flag_mode|default('static') }}";
		const prefix = "{{ challenge.flag_prefix|default('CTF{') }}";
		const suffix = "{{ challenge.flag_suffix|default('}') }}";
		const length = "{{ challenge.random_flag_length|default(10)}}";

		let pattern = '';
		if (mode === 'random' && length > 0) {
			pattern = prefix + '<ran_' + length + '>' + suffix;
		} else {
			pattern = prefix + suffix;
		}

		document.getElementById('flag_pattern').value = pattern;
	});
</script>

<!-- Hidden fields (auto-filled by JavaScript) -->
<input type="hidden" id="flag_mode" name="flag_mode" value="{{ challenge.flag_mode|default('static') }}" />
<input type="hidden" id="flag_prefix" name="flag_prefix" value="{{ challenge.flag_prefix|default('CTF{') }}" />
<input type="hidden" id="flag_suffix" name="flag_suffix" value="{{ challenge.flag_suffix|default('}') }}" />
<input type="hidden" id="random_flag_length" name="random_flag_length"
	value="{{ challenge.random_flag_length|default(0) }}" />

{% endblock %}