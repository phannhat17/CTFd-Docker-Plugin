{% extends "container_base.html" %}

{% block menu %}
{% include "config/container_menu.html" %}
{% endblock %}

{% block panel %}

<div class="alert alert-info mb-3">
	<i class="fas fa-info-circle"></i>  Auto refreshes every 15 seconds.
</div>

<div class="btn-group mb-2" role="group">
	<button type="button" class="btn btn-outline-primary" data-toggle="tooltip" title="" id="instances-refresh-button"
		data-test-id="cm-button-refresh" data-original-title="Refresh" onclick="location.reload()">
		<i class="btn-fa fas fa-sync-alt"></i>
	</button>
	<button type="button" class="btn btn-outline-danger" data-toggle="tooltip" title="" id="instances-delete-button"
		data-test-id="cm-button-destroy" data-original-title="Destroy Instances" onclick="bulkDeleteContainers()">
		<i class="btn-fa fas fa-trash-alt"></i>
	</button>
</div>

<table class="table table-striped border">
	<thead>
		<tr>
			<th class="border-right" data-checkbox>
				<div class="form-check text-center" data-test-id="cm-checkbox-all">&nbsp; <input type="checkbox"
						class="form-check-input" data-checkbox-all id="select-all">
				</div>
			</th>
			<th class="sort-col text-center">
				<b>Challenge</b>
				</td>
			<th class="sort-col text-center">
				<b>Container ID</b>
				</td>
			<th class="sort-col text-center">
				<b>Team/User</b>
				</td>
			<th class="text-center">
				<b>Status</b>
				</td>
			<th class="sort-col text-center">
				<b>Created</b>
				</td>
			<th class="sort-col text-center">
				<b>Expires</b>
			</td>
			<th class="text-center">
				<b>Port</b>
				</td>
			<th class="text-center">
				<b>Destroy</b>
				</td>
		</tr>
	</thead>
	<tbody>
		{% if running_instances and running_instances|length > 0 %}
		{% for instance in running_instances %}
		<tr data-instance-id="{{ instance.id }}">
			<td class="border-right" data-checkbox>
				<div class="form-check text-center">&nbsp; <input type="checkbox" class="form-check-input container-checkbox"
						value="{{ instance.id }}">
				</div>
			</td>
			<td class="text-center">
				<div class="form-check" id="challenge-id-div">
					<a href="{{ url_for('admin.challenges_detail', challenge_id=instance.challenge_id) }}">
						{{ instance.challenge.name }}
					</a>
				</div>
			</td>
			<td class="text-center">
				<div class="form-check text-center">
					{{ instance.container_id[:12] if instance.container_id else 'N/A' }}
				</div>
			</td>
			<td class="text-center">
				{% if is_teams_mode %}
					{% set team = instance.account_id | get_team %}
					{% if team %}
					<a href="{{ url_for('admin.teams_detail', team_id=team.id) }}">
						{{ team.name }}
					</a>
					{% else %}
					Team #{{ instance.account_id }}
					{% endif %}
				{% else %}
					{% set user = instance.account_id | get_user %}
					{% if user %}
					<a href="{{ url_for('admin.users_detail', user_id=user.id) }}">
						{{ user.name }}
					</a>
					{% else %}
					User #{{ instance.account_id }}
					{% endif %}
				{% endif %}
			</td>
			<td class="text-center">
				<div class="form-check text-center">
					<span class="badge badge-{{ 'success' if instance.status == 'running' else 'warning' if instance.status == 'provisioning' else 'secondary' }}">
						{{ instance.status }}
					</span>
				</div>
			</td>
			<td class="text-center timestamp">
				{{ instance.created_at.timestamp() if instance.created_at else '' }}
			</td>
			<td class="text-center timestamp">
				{{ instance.expires_at.timestamp() if instance.expires_at else '' }}
			</td>
			<td class="text-center">
				<div class="form-check text-center">
					{{ instance.connection_port if instance.connection_port else 'N/A' }}
				</div>
			</td>
			<td class="text-center">
				<button class="btn btn-link p-0 delete-instance" onclick="deleteInstance({{ instance.id }})"
					title="Destroy">
					<i class="btn-fa fas fa-trash-alt"></i>
				</button>
			</td>
		</tr>
		{% endfor %}
		{% else %}
		<tr>
			<td colspan="9" class="text-center text-muted">
				No container instances found
			</td>
		</tr>
		{% endif %}
	</tbody>
</table>
{% include "config/container_status.html" %}
{% endblock %}

{% block scripts %}
<script>
	document.addEventListener("DOMContentLoaded", function () {
		function convertToGMT7() {
			document.querySelectorAll(".timestamp").forEach(element => {
				let originalTime = element.innerText.trim(); // Get the timestamp directly from the cell
				if (!originalTime) return;

				// Convert to Date object
				let dateObj = new Date(originalTime * 1000);
				// Convert to GMT+7 manually
				let utcTime = dateObj.getTime() + dateObj.getTimezoneOffset() * 60000; // Convert to UTC
				let gmt7Date = new Date(utcTime + (7 * 3600000)); // Add 7 hours

				// Extract parts
				let hours = String(gmt7Date.getHours()).padStart(2, '0');
				let minutes = String(gmt7Date.getMinutes()).padStart(2, '0');
				let seconds = String(gmt7Date.getSeconds()).padStart(2, '0');
				let day = String(gmt7Date.getDate()).padStart(2, '0');
				let month = String(gmt7Date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
				let year = gmt7Date.getFullYear();

				// Format as "HH:mm:ss DD/MM/YYYY"
				let formattedTime = `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;

				// Update the element with the formatted time
				element.innerText = formattedTime;
			});
		}

		convertToGMT7();
	});
	
	// Auto-reload every 15 seconds
	setInterval(function() {
		location.reload();
	}, 15000);

	function deleteInstance(instanceId) {
		if (!confirm('Are you sure you want to delete this container?')) return;
		
		fetch('{{ url_for("containers_admin.api_instances") }}/' + instanceId, {
			method: 'DELETE',
			headers: {
				'Content-Type': 'application/json',
				'CSRF-Token': init.csrfNonce
			}
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				window.location.reload();
			} else {
				alert('Error: ' + (data.error || 'Unknown error'));
			}
		})
		.catch(error => {
			console.error('Error:', error);
		});
	}

	function bulkDeleteContainers() {
		let selectedContainers = [];
		document.querySelectorAll(".container-checkbox:checked").forEach(checkbox => {
			selectedContainers.push(checkbox.value);
		});

		if (selectedContainers.length === 0) {
			alert("Please select at least one container to delete.");
			return;
		}

		let confirmDelete = confirm(`Are you sure you want to delete ${selectedContainers.length} container(s)?`);
		if (!confirmDelete) return;

		fetch('{{ url_for("containers_admin.api_bulk_delete") }}', {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
				"Accept": "application/json",
				"CSRF-Token": init.csrfNonce
			},
			body: JSON.stringify({ instance_ids: selectedContainers }),
		})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					window.location.reload();
				} else {
					alert("Error deleting containers: " + (data.error || "Unknown error"));
				}
			})
			.catch(error => {
				console.error("Error:", error);
			});
	}
</script>
{% endblock %}
