{% extends "admin/base.html" %}

{% block content %}
<div class="jumbotron">
	<div class="container">
		<h1>Container Management</h1>
	</div>
</div>
<div class="container-fluid">
	<ul class="nav nav-tabs mb-3">
		<li class="nav-item">
			<a class="nav-link active" href="{{ url_for('containers_admin.dashboard') }}">Instances</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" href="{{ url_for('containers_admin.settings') }}">Settings</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" href="{{ url_for('containers_admin.cheats') }}">Anti-Cheat Logs</a>
		</li>
	</ul>

	<div class="alert alert-info mb-3">
		<strong>Status:</strong> {{ running_count }} running / {{ total_count }} total instances
	</div>

	<div class="btn-group mb-2" role="group">
		<button type="button" class="btn btn-outline-danger" onclick="bulkDeleteContainers()">
			<i class="fas fa-trash-alt"></i> Delete Selected
		</button>
		<button type="button" class="btn btn-outline-info" onclick="location.reload()">
			<i class="fas fa-sync"></i> Refresh
		</button>
	</div>

	<table class="table table-striped border">
		<thead>
			<tr>
				<th class="border-right text-center">
					<input type="checkbox" class="form-check-input" id="select-all">
				</th>
				<th class="text-center"><b>Challenge</b></th>
				<th class="text-center"><b>Container ID</b></th>
				<th class="text-center"><b>Team/User</b></th>
				<th class="text-center"><b>Status</b></th>
				<th class="text-center"><b>Created</b></th>
				<th class="text-center"><b>Expires</b></th>
				<th class="text-center"><b>Port</b></th>
				<th class="text-center"><b>Actions</b></th>
			</tr>
		</thead>
		<tbody>
			{% if instances and instances|length > 0 %}
			{% for instance in instances %}
			<tr data-instance-id="{{ instance.id }}">
				<td class="border-right text-center">
					<input type="checkbox" class="form-check-input container-checkbox" value="{{ instance.id }}">
				</td>
				<td class="text-center">
					<a href="{{ url_for('admin.challenges_detail', challenge_id=instance.challenge_id) }}">
						{{ instance.challenge.name }}
					</a>
				</td>
				<td class="text-center">
					<code>{{ instance.container_id[:12] if instance.container_id else 'N/A' }}</code>
				</td>
				<td class="text-center">
					{% if instance.team_id %}
					<a href="{{ url_for('admin.teams_detail', team_id=instance.team_id) }}">
						{{ instance.team.name }}
					</a>
					{% elif instance.user_id %}
					<a href="{{ url_for('admin.users_detail', user_id=instance.user_id) }}">
						{{ instance.user.name }}
					</a>
					{% else %}
					N/A
					{% endif %}
				</td>
				<td class="text-center">
					<span class="badge badge-{{ 'success' if instance.status == 'running' else 'warning' if instance.status == 'provisioning' else 'secondary' }}">
						{{ instance.status }}
					</span>
				</td>
				<td class="text-center">
					{{ instance.created_at.strftime('%Y-%m-%d %H:%M:%S') if instance.created_at else 'N/A' }}
				</td>
				<td class="text-center">
					{{ instance.expires_at.strftime('%Y-%m-%d %H:%M:%S') if instance.expires_at else 'Never' }}
				</td>
				<td class="text-center">
					{{ instance.exposed_port if instance.exposed_port else 'N/A' }}
				</td>
				<td class="text-center">
					<button class="btn btn-sm btn-danger" onclick="deleteInstance({{ instance.id }})">
						<i class="fas fa-trash"></i>
					</button>
				</td>
			</tr>
			{% endfor %}
			{% else %}
			<tr>
				<td colspan="9" class="text-center text-muted">
					No container instances found
				</td>
			</tr>
			{% endif %}
		</tbody>
	</table>
</div>
{% endblock %}

{% block scripts %}
<script>
// Select all checkbox
document.getElementById('select-all').addEventListener('change', function() {
	const checkboxes = document.querySelectorAll('.container-checkbox');
	checkboxes.forEach(cb => cb.checked = this.checked);
});

// Delete single instance
function deleteInstance(instanceId) {
	if (!confirm('Are you sure you want to delete this container?')) return;
	
	fetch('{{ url_for("containers_admin.api_instances") }}/' + instanceId, {
		method: 'DELETE',
		headers: {
			'Content-Type': 'application/json',
			'CSRF-Token': '{{ Session.nonce }}'
		}
	})
	.then(r => r.json())
	.then(data => {
		if (data.success) {
			location.reload();
		} else {
			alert('Error: ' + (data.error || 'Unknown error'));
		}
	})
	.catch(e => alert('Network error: ' + e));
}

// Bulk delete
function bulkDeleteContainers() {
	const selected = Array.from(document.querySelectorAll('.container-checkbox:checked'))
		.map(cb => parseInt(cb.value));
	
	if (selected.length === 0) {
		alert('Please select at least one container');
		return;
	}
	
	if (!confirm(`Delete ${selected.length} container(s)?`)) return;
	
	fetch('{{ url_for("containers_admin.api_bulk_delete") }}', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'CSRF-Token': '{{ Session.nonce }}'
		},
		body: JSON.stringify({ instance_ids: selected })
	})
	.then(r => r.json())
	.then(data => {
		if (data.success) {
			location.reload();
		} else {
			alert('Error: ' + (data.error || 'Unknown error'));
		}
	})
	.catch(e => alert('Network error: ' + e));
}
</script>
{% endblock %}
